name: Preview Deploy

on:
  push:
    branches-ignore:
      - main

jobs:
  preview:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        env:
          DATABASE_URL: ${{ secrets.PREVIEW_DATABASE_URL }}
          DIRECT_URL: ${{ secrets.PREVIEW_DATABASE_URL }}
        run: npx prisma generate

      - name: Test database connection
        env:
          DATABASE_URL: ${{ secrets.PREVIEW_DATABASE_URL }}
          DIRECT_URL: ${{ secrets.PREVIEW_DATABASE_URL }}
        run: |
          echo "Testing connection with preview database..."
          npx prisma db execute --stdin <<< "SELECT 1" || echo "Preview database connection failed"
          
      - name: Run database migration
        env:
          DATABASE_URL: ${{ secrets.PREVIEW_DATABASE_URL }}
          DIRECT_URL: ${{ secrets.PREVIEW_DATABASE_URL }}
        run: |
          echo "Running migrations on preview database..."
          echo "Generating Prisma Client..."
          npx prisma generate
          echo "Pushing schema to database..."
          npx prisma db push --accept-data-loss
          echo "Schema push complete."

      - name: Run database seed
        env:
          DATABASE_URL: ${{ secrets.PREVIEW_DATABASE_URL }}
          DIRECT_URL: ${{ secrets.PREVIEW_DATABASE_URL }}
        run: |
          echo "Running seed on preview database..."
          if [ -f "prisma/seed.ts" ]; then
            npm run db:seed
          else
            echo "No seed file found. Skipping seed..."
          fi
        continue-on-error: true

      - name: Deploy to Vercel Preview
        uses: amondnet/vercel-action@v25
        env:
          DATABASE_URL: ${{ secrets.PREVIEW_DATABASE_URL }}
          DIRECT_URL: ${{ secrets.PREVIEW_DATABASE_URL }}
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Notify Slack on Success
        if: success() && env.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          MESSAGE="ðŸ” ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã—ãŸï¼\n"
          MESSAGE+="ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref_name }}\n"
          MESSAGE+="ã‚³ãƒŸãƒƒãƒˆ: ${{ github.sha }}"
          
          curl -X POST -H 'Content-type: application/json' \
          --data "{\"text\":\"$MESSAGE\"}" \
          ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify Slack on Failure
        if: failure() && env.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          MESSAGE="âŒ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¤±æ•—ã—ã¾ã—ãŸã€‚\n"
          MESSAGE+="ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref_name }}\n"
          MESSAGE+="ã‚³ãƒŸãƒƒãƒˆ: ${{ github.sha }}\n"
          MESSAGE+="ç¢ºèªã—ã¦ãã ã•ã„: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          curl -X POST -H 'Content-type: application/json' \
          --data "{\"text\":\"$MESSAGE\"}" \
          ${{ secrets.SLACK_WEBHOOK_URL }}